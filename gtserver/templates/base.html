{% load static %}
{% load custom_tags %}

<!DOCTYPE html>
<html>
  <head>
    <!--Import JQuery-->
    <script type="text/javascript" src="{% static 'js/jquery-3.5.1.min.js' %}"></script>

    <!--Import materialize.css-->
    {% if company == 'joga' %}
    <link type="text/css" rel="stylesheet" href="{% static 'css/materialize_light-blue.min.css' %}"  media="screen,projection"/>
    {% elif company == 'supplier' %}
    <link type="text/css" rel="stylesheet" href="{% static 'css/materialize_green.min.css' %}"  media="screen,projection"/>
    {% elif company == 'customer' %}
    <link type="text/css" rel="stylesheet" href="{% static 'css/materialize_red.min.css' %}"  media="screen,projection"/>
    {% else %}
    <link type="text/css" rel="stylesheet" href="{% static 'css/materialize_grey.min.css' %}"  media="screen,projection"/>
    {% endif %}
    
    <!--Import materialize.js-->
    <script type="text/javascript" src="{% static 'js/materialize.min.js' %}"></script>

    <!--Import materialize.icons.css-->
    <link type="text/css" rel="stylesheet" href="{% static 'css/materialize.icons.css' %}"/>

    <!--Import custom.css-->
    <link type="text/css" rel="stylesheet" href="{% static 'css/custom.css' %}"/>

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <title>{% block title %}ERP{% endblock %} | {% if company == 'joga' %}JOGA{% elif company == 'supplier' %}Lieferant{% elif company == 'customer' %}Kunde{% else %}ERP{% endif %}</title>
    
    <!-- Head-->
    {% block head %}

    {% endblock %}

  </head>

  <body>

    <!-- Navbar-->
    <div class="navbar-fixed" style="z-index: 9999;">
      <nav>
        <div class="nav-wrapper">
          <a href="#" data-target="sidenav" class="sidenav-trigger"><i class="material-icons">menu</i></a>
          <a href="{% url 'home' %}" class="hide-on-med-and-down brand-logo left">{% if company == 'joga' %}JOGA{% else %}{{ user.groups.first.name_de }}{% endif %}</a>
          {% if user.is_authenticated %}
          <ul class="right">
            <li><a id="currenttime"><i class="material-icons left">today</i>Tag {{day}}</a>
            {% if perms.gtapp.view_message %}<li><a href="{% url 'inbox' %}"><i class="material-icons">chat_bubble</i></a></li>{% endif %}
            {% if perms.gtapp.view_suppcontainer or perms.gtapp.view_custcontainer %}<li><a href=""><i class="material-icons">qr_code</i></a></li>{% endif %}
            <!--<li><a class="dropdown-trigger-tasks" href="#" data-target='tasks'><i class="material-icons">notifications_outline</i></a></li>-->
            {% if perms.gtapp.view_todo %}<li><a id="notificationicon" href="#" data-target="tasks" class="sidenav-trigger show-on-large" style="margin-left: 0; margin-right: 0;"><i class="material-icons">notifications_none</i></a></li>{% endif %}
          </ul>
          {% else %}
          <ul class="right">
            <li><a href="{% url 'login' %}"><i class="material-icons left">login</i>Einloggen</a></li>
          </ul>
          {% endif %}
        </div>
      </nav>
    </div>


    {% if user.is_authenticated %}
    <!-- Sidenav-->
    <ul class="sidenav sidenav-fixed sidenav-left" id="sidenav" >
      <li class="hide-on-med-and-down" style="height: 64px"></li>
      <li><div class="user-view">
        <div class="background">
          <img style="filter: brightness(50%);" src="{% static 'img/logistics-300px.jpg' %}">
        </div>
        <a {% if debug_flag %} href="{% url 'change_user' %}"{% endif %}><img class="grey lighten-2 circle" src="{% static 'img/avataaars.svg' %}"></a>
        <a><span class="white-text name">{{ user.username }}</span></a>
        <a><span class="white-text email">{{ user.groups.first.name_de }}</span></a>
      </div></li>
      <li><a href="{% url 'home' %}">Startseite</a></li>
      {% if perms.gtapp.view_todo %}<li><a href="{% url 'tasks' %}">Aufgaben</a></li>{% endif %}
      <li><div class="divider"></div></li>
      {# <li><a class="subheader">Meine Seiten</a></li> #}
      {% if perms.gtapp.view_custorder %}<li><a href="{% url 'cust_order' %}">{% if company == 'customer' %}Bestellungen{% else %}Aufträge{% endif %}</a></li>{% endif %}
      {% if perms.gtapp.view_custcomplaint %}<li><a href="{% url 'cust_complaint' %}">{% if company == 'customer' %}Bestellreklamationen{% else %}Auftragsreklamationen{% endif %}</a></li>{% endif %}
      {% if perms.gtapp.view_supporder %}<li><a href="{% url 'supp_order' %}">{% if company == 'supplier' %}Aufträge{% else %}Bestellungen{% endif %}</a></li>{% endif %}
      {% if perms.gtapp.view_suppcomplaint %}<li><a href="{% url 'supp_complaint' %}">{% if company == 'supplier' %}Auftragsreklamationen{% else %}Bestellreklamationen{% endif %}</a></li>{% endif %}
      {% if request.user|has_group:"production" %}<li><a href="{% url 'Production_steps' %}">Produktionsschritte</a></li> {% endif %}
      {% if request.user|has_group:"production service" %}<li><a href="{% url 'manufacturing_list' %}">Fertigungsaufträge</a></li> {% endif %}
      {% if request.user|has_group:"production service" or request.user|has_group:"suppliers" %}<li><a href="{% url 'manufacturing_stock' %}">Lager</a></li> {% endif %}
      {# <li><div class="divider"></div></li> #}
      {% if user.is_authenticated %}
          <li><div class="divider"></div></li>
          <li><a href="{% url 'logout' %}"><i class="material-icons left">exit_to_app</i>Ausloggen</a></li>
          {% endif %}
      {# <li><a href="">Dashboard</a></li> #}
    </ul>
    {% endif %}

    {% if perms.gtapp.view_todo %}
    <!-- Tasks-->
    <ul id="tasks" class="sidenav">
      <li class="hide-on-med-and-down" style="height: 64px"></li>
      {#<li><a class="sidenav-close"><i class="material-icons">arrow_back</i>ZURÜCK</a></li>#}
      <li><a href="{% url 'tasks' %}">Aufgabenübersicht öffnen</a></li>
      <li><div class="divider"></div></li>
      <li><a class="subheader">Mir zugewiesen</a></li>
      <li id="tasks_user">
      </li>
      <li><div class="divider"></div></li>
      <li><a class="subheader">Nicht zugewiesen</a></li>
      <li id="tasks_group">
      </li>
    </ul>
    {% endif %}

    <!-- Content-->
    {% block overwritebody %}
    <main {% if user.is_authenticated %}class="loggedin"{% endif %}>
      <div id="content" class="container">
        {% block content %}
        {% endblock %}
      </div>
    </main>
    {% endblock %}

    <!-- Additional Body-->
    {% block body %}

    {% endblock %}

    <!-- Scripts-->
    <script>
        $(document).ready(function(){
          $('.sidenav-left').sidenav();
          $('.dropdown-trigger').dropdown();
          $('.collapsible').collapsible();

          {% if perms.gtapp.view_todo %}
          var options = {
            'edge': 'right',
            'onOpenStart': getTasks
          }
          M.Sidenav.init($("#tasks"), options);
          {% endif %}
        });

        {% if perms.gtapp.view_todo %}
        function getTasks(){
          var request = new XMLHttpRequest();
          request.open("GET","{% url 'api_tasks' %}");
          request.addEventListener('load', function(event) {
            if (request.status >= 200 && request.status < 300) {
              var obj = JSON.parse(request.responseText);
              // Nicht zugewiesen
              var out = '';
              if (obj.tasks_group.length>0){
                for(let i=0; i<obj.tasks_group.length; i++){
                  task = obj.tasks_group[i];
                  out += '<li class="no-padding"><ul class="collapsible collapsible-accordion"><li>\
                    <a class="collapsible-header"><i class="material-icons">expand_more</i>' + task.title + '</a>\
                    <div class="collapsible-body"><ul>\
                        <li><a href=""><i class="material-icons left">info</i>' + task.ref + '</a></li>\
                        <li><a href="/tasks_assign/' + task.id + '/"><i class="material-icons left">launch</i>Mir zuweisen</a></li>\
                        <li><a href="/tasks_detail/' + task.id + '/"><i class="material-icons left">subject</i>Detailseite aufrufen</a></li>\
                      </ul></div>\
                  </li></ul></li>';
                }
                $('#tasks_group')[0].innerHTML = out;
              } else {
                $('#tasks_group')[0].innerHTML = '<li><a><i class="material-icons left">done_all</i>Keine</a></li>';
              }
              // Mir zugewiesen
              out = '';
              if (obj.tasks_user.length>0){
                for(let i=0; i<obj.tasks_user.length; i++){
                  task = obj.tasks_user[i];
                  out += '<li class="no-padding"><ul class="collapsible collapsible-accordion"><li>\
                    <a class="collapsible-header"><i class="material-icons">expand_more</i>' + task.title + '</a>\
                    <div class="collapsible-body"><ul>\
                        <li><a href=""><i class="material-icons left">info</i>' + task.ref + '</a></li>\
                        <li><a href="/tasks_finish/' + task.id + '/"><i class="material-icons left">done</i>Fertig</a></li>\
                        <li><a href="/tasks_detail/' + task.id + '/"><i class="material-icons left">subject</i>Detailseite aufrufen</a></li>\
                      </ul></div>\
                  </li></ul></li>';
                }
                $('#tasks_user')[0].innerHTML = out;
              } else {
                $('#tasks_user')[0].innerHTML = '<li><a><i class="material-icons left">done_all</i>Keine</a></li>';
              }
              $('.collapsible').collapsible();
            } else {
              console.warn(request.statusText, request.responseText);
            }
          });
          request.send();
        }
        {% endif %}
            
    </script>
    <script>
      $(document).ready(function(){
        getStatus();
        setInterval(getStatus, 10000);
      });
      function getStatus(){
        var request = new XMLHttpRequest();
        request.open("GET","{% url 'api_status' %}");
        request.addEventListener('load', function(event) {
          if (request.status >= 200 && request.status < 300) {
            var obj = JSON.parse(request.responseText);
            $('#currenttime')[0].innerHTML = '<i class="material-icons left">today</i>Tag ' + obj['time'];

            {% if perms.gtapp.view_todo %}
            if (obj['has_unassigned']) $("#notificationicon")[0].innerHTML='<i class="material-icons">notifications_active</i>';
            else $("#notificationicon")[0].innerHTML='<i class="material-icons">notifications_none</i>';
            {% endif %}

          } else {
            console.warn(request.statusText, request.responseText);
          }
        });
        request.send();
      }
      
    </script>
    {% block scripts %}
    {% endblock %}
  </body>
</html>